<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Шаклеин 8091</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <div class="container">
        <div class="row">
            <div class="d-flex vh-100 col row">
                <div class="align-self-center jumbotron col" style="min-height:75%; margin-bottom: 0">
                    <div class="row">
                        <form class="col">
                            <div class="form-group">
                                <input type="text" class="form-control" id="polynomial">
                            </div>
                        </form>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12 col-md-auto">
                            <ul class="nav nav-tabs">
                                <li class="nav-item">
                                    <a href="#raus" class="nav-link active" data-toggle="tab">
                                        Метод Рауса
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href="#gurvic" class="nav-link" data-toggle="tab">Метод Гурвица</a>
                                </li>
                                <li class="nav-item">
                                    <a href="#miha" class="nav-link" data-toggle="tab">Метод Михайлова</a>
                                </li>
                            </ul>
                            <div class="tab-content">
                                <div class="tab-pane fade show active" id="raus">
                                    <table class="table table-bordered table-responsive-md">
                                        <tbody id="rausTable"></tbody>
                                    </table>
                                </div>
                                <div class="tab-pane fade" id="gurvic">
                                    <table class="table table-bordered table-responsive-md">
                                        <tbody id="gurvicTable"></tbody>
                                    </table>
                                    <div id="gurvicDets" class="row">

                                    </div>
                                </div>
                                <div class="tab-pane fade" id="miha">
                                    <canvas id="miha-canvas" width="400" height="400"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col order-first order-md-last">
                            <div class="row">
                                <blockquote class="blockquote text-right col-6 col-md-12">
                                    <h3 id="rausResult" class="text-success mb-0">Система устойчива</h3>
                                    <footer class="blockquote-footer">По Раусу</footer>
                                </blockquote>
                                <blockquote class="blockquote text-right col-6 col-md-12">
                                    <h3 id="gurvicResult" class="text-success mb-0">Система устойчива</h3>
                                    <footer class="blockquote-footer">По Гурвицу</footer>
                                </blockquote>
                                <blockquote class="blockquote text-right col-6 col-md-12 d-none d-md-block">
                                    <h3 id="mihaResult" class="text-success mb-0">Система устойчива</h3>
                                    <footer class="blockquote-footer">По Михайлову</footer>
                                </blockquote>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/jquery-3.3.1.js"></script>
    <script src="js/bootstrap.bundle.js"></script>
    <script>
        function printMatrix(matrix, query) {
            var $table = $(query);
            $table.html("");
            for (var i = 0; i < matrix.length; i++) {
                var tr = $table.append($("<tr></tr>"));
                for (var j = 0; j < matrix[i].length; j++) {
                    tr.append("<td data-row='" + i + "' data-column='" + j + "'>" + matrix[i][j].toFixed(2) +
                        "</td>");
                }
            }
        }

        function solveRause(monomials) {
            var matrix = [
                [],
                []
            ];
            for (var i = monomials.length - 1; i >= 0; i -= 2) {
                matrix[0].push(monomials[i] || 0);
                matrix[1].push(monomials[i - 1] || 0);
            }
            for (var i = 2; i < monomials.length; i++) {
                var r = matrix[i - 2][0] / matrix[i - 1][0];
                matrix.push([]);
                for (var j = 0; j < monomials.length / 2; j++) {
                    matrix[i][j] = (matrix[i - 2][j + 1] - r * matrix[i - 1][j + 1]) || 0;
                }
            }
            printMatrix(matrix, "#rausTable");

            $("#rausResult").addClass("text-success").removeClass("text-danger").removeClass("text-white").text(
                "Система устойчива");
            for (var i = 1; i < matrix.length; i++) {
                if (matrix[0][0] * matrix[i][0] <= 0) {
                    $("#rausResult").removeClass("text-success").addClass("text-danger").text("Система не устойчива");
                    $("#rausTable td[data-row='" + i + "'][data-column='0']").addClass("bg-danger").addClass(
                        "text-white");
                }
            }

        }

        function det(matrix) {
            if (matrix.length == 1) {
                return matrix[0][0];
            } else {
                var result = 0;
                for (var i = 0; i < matrix.length; i++) {
                    var d = matrix[0][i] * det(matrix.slice(1).map(function (x) {
                        return [...x.slice(0, i), ...x.slice(i + 1)];
                    }));
                    result += (i % 2 == 0 ? d : -d);
                }
                return result;
            }
        }

        function solveGurvic(monomials) {
            var matrix = [];
            for (var i = 0; i < monomials.length - 1; i++) {
                matrix.push([]);
                for (var j = 0; j < monomials.length - 1; j++) {
                    matrix[i][j] = monomials[monomials.length - (2 - i + 2 * j)] || 0;
                }
            }

            var sign = det(matrix);
            $("#gurvicDets").html("");
            $("#gurvicResult").addClass("text-success").removeClass("text-danger").text("Система устойчива");
            $("#gurvicDets").html("");
            for (var i = 1; i <= matrix.length; i++) {
                var curr = det(matrix.slice(0, i).map(function (e) {
                    return e.slice(0, i)
                }));
                if (curr * sign <= 0) {
                    $("#gurvicResult").removeClass("text-success").addClass("text-danger").text("Система не устойчива");
                    $("#gurvicDets").append($("<span class='det col-6 text-danger'>Δ" + i + "=" + curr + "  </span>"));
                } else {
                    $("#gurvicDets").append($("<span class='det col-6'>Δ" + i + "=" + curr + "  </span>"));
                }
            }
            printMatrix(matrix, "#gurvicTable")
        }

        var mihaCanvas = document.getElementById("miha-canvas");
        var mctx = mihaCanvas.getContext("2d");

        function solveMiha(monomials) {
            var re = [],
                im = [];
            for (var i = 0; i < monomials.length; i++) {
                if (i % 2 != 0) {
                    if ((i + 1) % 4 != 0) {
                        im[i] = -monomials[i];
                    } else {
                        im[i] = monomials[i];
                    }
                } else {
                    if ((i) % 4 == 0) {
                        re[i] = monomials[i];
                    } else {
                        re[i] = -monomials[i];
                    }
                }
            }

            const calcMulti = (monomials, arg) => {
                let result = 0;
                for (let i = 0; i < monomials.length; i++) {
                    if (monomials[i]) {
                        result += monomials[i] * Math.pow(arg, i);
                    }
                }
                return result;
            };

            const getPart = (y, x) => {
                if (x == 0 || y == 0) {
                    return 0;
                } else if (x > 0) {
                    return y > 0 ? 1 : 4;
                } else {
                    return y > 0 ? 2 : 3;
                }
            }

            const PRECITION = 0.001;
            const RANGE = 100;
            const EPSILON = 0.1;
            let size = 0;
            let dots = [];
            let parts = 1;
            let prevPart = 1;
            for (let i = 0; i < RANGE; i += PRECITION) {
                const x = calcMulti(re, i);
                const y = calcMulti(im, i);
                if (Math.abs(x) < EPSILON) {
                    size = Math.max(size, Math.abs(y));
                }
                if (Math.abs(y) < EPSILON) {
                    size = Math.max(size, Math.abs(x));
                }
                dots.push({
                    x,
                    y
                });
                const part = getPart(x, y);
                if (part && parts >= 0) {
                    if (part != prevPart) {
                        if (((part - prevPart % 4) == 1)) {
                            parts++;
                        } else {
                            parts = -1;
                        }
                        prevPart = part;
                    }
                }
            }
            mctx.clearRect(0, 0, mihaCanvas.width, mihaCanvas.height);
            const m = (200 / size) * 0.9;
            mctx.fillStyle = "black";
            mctx.fillRect(200, 0, 1, 400);
            mctx.fillRect(0, 200, 400, 1);
            if (parts == monomials.length) {
                mctx.fillStyle = "green";
                mctx.strokeStyle = "green";
                $("#mihaResult").addClass("text-success").removeClass("text-danger").removeClass("text-white").text(
                    "Система устойчива");
            } else {
                mctx.fillStyle = "red";
                mctx.strokeStyle = "red";
                $("#mihaResult").removeClass("text-success").addClass("text-danger").text("Система не устойчива");
            }
            mctx.lineWidth="2";
            mctx.fillRect(dots[0].x * m + 195, dots[0].y * m + 195, 10, 10);
            const text = "(" + dots[0].x + "," + dots[0].y + ")";
            mctx.fillText(text, dots[0].x * m + 200 - mctx.measureText(text).width / 2, dots[0].y * m + 215);
            mctx.beginPath();
            mctx.moveTo(dots[0].x * m + 200, dots[0].y * m + 200);
            for (let i = 1; i < dots.length; i++) {
                mctx.lineTo(dots[i].x * m + 200, dots[i].y * m + 200); 
            }
            mctx.stroke();
        }

        $("#polynomial").on('input', function (e) {
            var val = e.target.value;
            if (!val.match(/^[\d\.\+\-p\^]+$/)) {
                $(this).addClass("is-invalid");
                return;
            } else {
                $(this).removeClass("is-invalid");
            }
            var monomialsStrs = val.match(/([-+\d\.]+)?p?(\^([\d]+))?/g);
            var monomials = [];
            for (var i = 0; i < monomialsStrs.length - 1; i++) {
                var parts = monomialsStrs[i].match(/^([-+\d\.]+)?p?(\^([\d]+))?$/);
                var index = ~parts[0].indexOf('p') ? (parts[3] ? Number(parts[3]) : 1) : 0;
                var coef = parts[1] ? (parts[
                    1] == '-' ? -1 : (parts[1] == '+' ? 1 : Number(parts[
                    1]))) : 1;
                if (index > 10) {
                    alert("Index are to big!");
                    $(this).addClass("is-invalid");
                    return;
                }
                monomials[index] = coef;
            }
            solveRause(monomials);
            solveGurvic(monomials);
            solveMiha(monomials);
        });
    </script>
</body>

</html>